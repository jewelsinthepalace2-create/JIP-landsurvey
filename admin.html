<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Land Survey - Admin Dashboard</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            shepherdDark: '#0F172A',
            shepherdCard: '#1E293B',
            shepherdGold: '#F2A20C',
          }
        }
      }
    }
  </script>
  <style>
    html { transition: background-color 0.3s ease, color 0.3s ease; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-shepherdDark dark:text-white min-h-screen pb-24 md:pb-8 font-sans transition-colors">

  <nav class="p-4 bg-white dark:bg-shepherdCard shadow-md sticky top-0 z-50 flex justify-between items-center border-b border-gray-200 dark:border-slate-700 transition-colors">
    <div class="flex gap-4 items-center">
      <a href="index.html" class="text-2xl font-bold text-shepherdGold tracking-tight">Land Survey</a>
      <div class="hidden md:flex gap-6 ml-8 font-medium">
        <a href="index.html" class="hover:text-shepherdGold transition-colors">Feed</a>
        <a href="survey.html" class="hover:text-shepherdGold transition-colors">Submit Survey</a>
        <a href="admin.html" class="text-shepherdGold transition-colors">Admin</a>
      </div>
    </div>
    <button id="themeToggleBtn" class="flex items-center justify-center px-4 py-2 rounded-full font-bold text-sm bg-gray-200 dark:bg-slate-700 hover:bg-gray-300 dark:hover:bg-slate-600 transition-colors">
      ‚òÄÔ∏è Light
    </button>
  </nav>

  <main class="p-4 max-w-6xl mx-auto mt-6 w-full flex flex-col gap-8">
    
    <div>
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">Admin Dashboard</h1>
      <p class="text-gray-500 dark:text-slate-300 text-sm mt-1">Manage survey teams and assign groups.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
      
      <div class="lg:col-span-1 bg-white dark:bg-shepherdCard p-6 rounded-2xl shadow-md border border-gray-200 dark:border-slate-700 h-fit transition-colors">
        <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 border-b border-gray-100 dark:border-slate-700 pb-2 text-center lg:text-left">
          Add Team Member
        </h2>
        
        <div id="successMessage" class="hidden mb-4 p-3 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-sm font-medium rounded-lg border border-green-200 dark:border-green-800">
        </div>

        <form id="addUserForm" class="flex flex-col gap-4">
          <div class="flex flex-col gap-1">
            <label class="text-xs font-bold text-gray-500 dark:text-slate-300 uppercase tracking-wide">Full Name</label>
            <input type="text" id="userName" required class="px-3 py-2 rounded-lg bg-gray-50 dark:bg-shepherdDark border border-gray-300 dark:border-slate-600 focus:outline-none focus:border-shepherdGold text-sm transition-colors text-slate-900 dark:text-white">
          </div>

          <div class="flex flex-col gap-1">
            <label class="text-xs font-bold text-gray-500 dark:text-slate-300 uppercase tracking-wide">Email</label>
            <input type="email" id="userEmail" required class="px-3 py-2 rounded-lg bg-gray-50 dark:bg-shepherdDark border border-gray-300 dark:border-slate-600 focus:outline-none focus:border-shepherdGold text-sm transition-colors text-slate-900 dark:text-white">
          </div>

          <div class="flex flex-col gap-1">
            <label class="text-xs font-bold text-gray-500 dark:text-slate-300 uppercase tracking-wide">Contact Number</label>
            <input type="tel" id="userContact" required placeholder="054..." class="px-3 py-2 rounded-lg bg-gray-50 dark:bg-shepherdDark border border-gray-300 dark:border-slate-600 focus:outline-none focus:border-shepherdGold text-sm transition-colors text-slate-900 dark:text-white">
          </div>

          <div class="flex flex-col gap-1">
            <label class="text-xs font-bold text-gray-500 dark:text-slate-300 uppercase tracking-wide">Initial Password</label>
            <input type="password" id="userPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="px-3 py-2 rounded-lg bg-gray-50 dark:bg-shepherdDark border border-gray-300 dark:border-slate-600 focus:outline-none focus:border-shepherdGold text-sm transition-colors text-slate-900 dark:text-white">
          </div>

          <div class="flex flex-col gap-1">
            <label class="text-xs font-bold text-gray-500 dark:text-slate-300 uppercase tracking-wide">Assign Group</label>
            <select id="userGroup" class="px-3 py-2 rounded-lg bg-gray-50 dark:bg-shepherdDark border border-gray-300 dark:border-slate-600 focus:outline-none focus:border-shepherdGold text-sm transition-colors text-slate-900 dark:text-white">
              <option value="1">Group A </option>
              <option value="2">Group B </option>
              <option value="3">Group C </option>
            </select>
          </div>

          <label class="flex items-center gap-2 cursor-pointer mt-2 group w-fit">
            <div class="relative flex items-center">
              <input type="checkbox" id="userLeader" class="peer sr-only">
              <div class="w-5 h-5 bg-gray-100 dark:bg-shepherdDark border-2 border-gray-300 dark:border-slate-600 rounded peer-checked:bg-shepherdGold peer-checked:border-shepherdGold transition-colors"></div>
              <span class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-shepherdDark opacity-0 peer-checked:opacity-100 font-bold text-sm pointer-events-none">‚úì</span>
            </div>
            <span class="text-sm font-medium text-gray-700 dark:text-white group-hover:text-shepherdGold transition-colors">
              Assign as Team Leader
            </span>
          </label>

          <button type="submit" id="submitBtn" class="mt-4 w-full bg-shepherdGold text-shepherdDark font-bold py-3 rounded-xl hover:bg-yellow-500 transition-colors shadow-sm disabled:opacity-50">
            Add User & Send Invite
          </button>
        </form>
      </div>

      <div id="rosterContainer" class="lg:col-span-2 flex flex-col gap-6">
          <div class="flex flex-col items-center justify-center py-20 gap-4">
              <div class="w-8 h-8 border-4 border-shepherdGold border-t-transparent rounded-full animate-spin"></div>
              <p class="text-gray-500 dark:text-gray-400 font-medium">Loading roster...</p>
          </div>
      </div>

    </div>
  </main>

  <div class="md:hidden flex justify-around items-center p-4 bg-white dark:bg-shepherdCard fixed bottom-0 w-full shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] border-t border-gray-200 dark:border-slate-700 z-50 transition-colors">
    <a href="index.html" class="text-sm font-bold flex flex-col items-center text-gray-500 dark:text-gray-400 hover:text-shepherdGold transition-colors"><span>üó∫Ô∏è</span> Feed</a>
    <a href="survey.html" class="text-sm font-bold flex flex-col items-center text-gray-500 dark:text-gray-400 hover:text-shepherdGold transition-colors"><span>üìù</span> Survey</a>
    <a href="admin.html" class="text-sm font-bold flex flex-col items-center text-shepherdGold transition-colors"><span>‚öôÔ∏è</span> Admin</a>
  </div>

  <script>
    const htmlElement = document.documentElement;
    const themeBtn = document.getElementById('themeToggleBtn');
    let isDarkMode = localStorage.getItem('theme') !== 'light';
    
    function updateThemeUI() {
      if (isDarkMode) {
        htmlElement.classList.add('dark');
        themeBtn.textContent = '‚òÄÔ∏è Light';
      } else {
        htmlElement.classList.remove('dark');
        themeBtn.textContent = 'üåô Dark';
      }
    }
    
    updateThemeUI();
    themeBtn.addEventListener('click', () => {
      isDarkMode = !isDarkMode;
      localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
      updateThemeUI();
    });

    const WORKER_URL = 'https://lucky-water-ff71.jewelsinthepalace2.workers.dev'; 

    const MOCK_GROUPS = [
      { id: 1, name: "Group A " },
      { id: 2, name: "Group B " },
      { id: 3, name: "Group C " }
    ];

    let USERS = [];
    const rosterContainer = document.getElementById('rosterContainer');

    async function fetchRoster() {
      try {
        const response = await fetch(`${WORKER_URL}/api/users`);
        USERS = await response.json();
        renderRoster();
      } catch (error) {
        console.error("Error fetching roster:", error);
        rosterContainer.innerHTML = `<p class="text-red-500 text-center font-bold">Failed to load roster.</p>`;
      }
    }

    function renderRoster() {
      rosterContainer.innerHTML = '';
      MOCK_GROUPS.forEach(group => {
        const groupUsers = USERS.filter(u => u.group_id == group.id || u.groupId == group.id);
        let usersHTML = '';
        if (groupUsers.length === 0) {
          usersHTML = `<p class="p-5 text-sm text-gray-500 dark:text-gray-400 text-center">No users assigned yet.</p>`;
        } else {
          groupUsers.forEach(user => {
            const isLeader = user.is_team_leader == 1 || user.isLeader;
            const leaderBadge = isLeader 
              ? `<span class="text-[10px] uppercase font-bold bg-shepherdGold/20 text-shepherdGold border border-shepherdGold/30 px-1.5 py-0.5 rounded-sm tracking-wider ml-2">Leader ‚≠ê</span>` 
              : '';

            usersHTML += `
              <div class="p-5 flex flex-col sm:flex-row justify-between sm:items-center gap-4 hover:bg-gray-50 dark:hover:bg-slate-800/30 transition-colors">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-slate-700 flex items-center justify-center text-lg font-bold text-gray-500 dark:text-gray-300 shrink-0 uppercase">
                    ${user.name.charAt(0)}
                  </div>
                  <div>
                    <p class="font-bold text-gray-900 dark:text-white flex items-center">
                      ${user.name} ${leaderBadge}
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${user.email}</p>
                  </div>
                </div>
                <a href="tel:${user.contact_number || user.contact}" class="w-full sm:w-auto text-center px-5 py-2 bg-gray-100 dark:bg-slate-700 text-gray-800 dark:text-white text-sm font-bold rounded-lg hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors">
                  üìû Call
                </a>
              </div>
            `;
          });
        }

        const groupHTML = `
          <div class="bg-white dark:bg-shepherdCard rounded-2xl shadow-sm border border-gray-200 dark:border-slate-700 overflow-hidden transition-colors">
            <div class="bg-gray-50 dark:bg-slate-800/50 px-5 py-3 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center">
              <h3 class="font-bold text-gray-900 dark:text-white flex items-center gap-2">üìÅ ${group.name}</h3>
              <span class="text-xs font-bold bg-gray-200 dark:bg-slate-700 text-gray-600 dark:text-gray-300 px-2 py-1 rounded-md">${groupUsers.length} Members</span>
            </div>
            <div class="divide-y divide-gray-100 dark:divide-slate-700/50">
              ${usersHTML}
            </div>
          </div>
        `;
        rosterContainer.insertAdjacentHTML('beforeend', groupHTML);
      });
    }

    const addUserForm = document.getElementById('addUserForm');
    const submitBtn = document.getElementById('submitBtn');
    const successMessage = document.getElementById('successMessage');

    addUserForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.textContent = 'Saving & Emailing...';
      submitBtn.disabled = true;

      const newUserPayload = {
        name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value,
        contact: document.getElementById('userContact').value,
        password: document.getElementById('userPassword').value, // CAPTURING PASSWORD
        groupId: parseInt(document.getElementById('userGroup').value),
        isLeader: document.getElementById('userLeader').checked
      };

      try {
        const response = await fetch(`${WORKER_URL}/api/users`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newUserPayload)
        });

        if (response.ok) {
          successMessage.textContent = `${newUserPayload.name} added successfully!`;
          successMessage.classList.remove('hidden');
          addUserForm.reset();
          fetchRoster(); 
        } else {
          throw new Error("Worker error");
        }
      } catch (err) {
        alert("Error adding user. Check connectivity.");
      } finally {
        submitBtn.textContent = 'Add User & Send Invite';
        submitBtn.disabled = false;
        setTimeout(() => successMessage.classList.add('hidden'), 4000);
      }
    });

    fetchRoster();
  </script>
</body>
</html>